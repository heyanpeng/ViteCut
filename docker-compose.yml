# ViteCut 前后端 - 使用云服务器上的 MySQL
# 在项目根目录创建 .env 配置 MYSQL_HOST、MYSQL_USER、MYSQL_PASSWORD、MYSQL_DATABASE
# 构建: docker compose build  启动: docker compose up -d

services:
  vitecut-api:
    image: vitecut-api:latest
    build:
      context: .
      dockerfile: packages/api/Dockerfile
    container_name: vitecut-api
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production # 生产环境变量
      - PORT=3001 # API 端口
      - MYSQL_HOST=${MYSQL_HOST} # MySQL 主机地址，从 .env 读取
      - MYSQL_PORT=${MYSQL_PORT:-3306} # MySQL 端口，默认 3306
      - MYSQL_USER=${MYSQL_USER} # MySQL 用户名，从 .env 读取
      - MYSQL_PASSWORD=${MYSQL_PASSWORD} # MySQL 密码，从 .env 读取
      - MYSQL_DATABASE=${MYSQL_DATABASE:-vitecut} # 数据库名，默认 vitecut
    volumes:
      - vitecut-uploads:/app/packages/api/uploads
      - vitecut-output:/app/packages/api/output

  vitecut-app:
    image: vitecut-app:latest
    build:
      context: .
      dockerfile: packages/app/Dockerfile
    container_name: vitecut-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      - vitecut-api

volumes:
  vitecut-uploads: # 持久化卷，用于存储上传文件
  vitecut-output: # 持久化卷，用于存储输出结果
